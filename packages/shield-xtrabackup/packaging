# abort script on any command that exits with a non zero value
set -e
set -x

PREFIX=${BOSH_INSTALL_TARGET}

export PATH=$PATH:${BOSH_INSTALL_TARGET}/bin:/var/vcap/packages/mariadb/bin

# socat
tar xzf xtrabackup/socat-*.tar.gz
(
  set -e
  cd socat-*/
  ./configure --prefix=$PREFIX
  make
  make install prefix=$PREFIX
)

# DBI-perl
tar xzf xtrabackup/libdbi-perl_*.orig.tar.gz
(
  set -e
  cd DBI-*/
  perl Makefile.PL PREFIX=$PREFIX
  make
  make install prefix=$PREFIX
)

# DBD-mysql-perl
tar xzf xtrabackup/libdbd-mysql-perl_*.orig.tar.gz
(
  set -e
  cd DBD-mysql-*/
  perl -I ${BOSH_INSTALL_TARGET}/lib/perl/5.*/ Makefile.PL PREFIX=$PREFIX
  make
  make install prefix=$PREFIX
)

# autoconf
tar xzf xtrabackup/autoconf-*.tar.gz
(
  set -e
  cd autoconf-*/
  autoconf_dir=$PREFIX/share/autoconf ./configure --prefix=$PREFIX
  make
  make install prefix=$PREFIX
)

# automake
tar xzf xtrabackup/automake-*.tar.gz
(
  set -e
  cd automake-*/
  ./configure --prefix=$PREFIX
  make
  make install prefix=$PREFIX
)

# libtool
tar xzf xtrabackup/libtool-*.tar.gz
(
  set -e
  cd libtool-*/
  ./configure --prefix=$PREFIX
  make
  make install prefix=$PREFIX
)

# libaio
tar xzf xtrabackup/libaio_*.orig.tar.gz
(
  set -e
  cd libaio-*/
  make install
)

# libev
tar xzf xtrabackup/libev-*.tar.gz
(
  set -e
  cd libev-*/
  ./configure --prefix=$PREFIX
  make
  make install prefix=$PREFIX
)

# boost
tar zxf  xtrabackup/boost_*.tar.gz
(
  set -e
  cd boost_*/
  mv boost $PREFIX
)

# xtrabackup

tar xzf xtrabackup/percona-xtrabackup-*.tar.gz
(
  set -e
  cd percona-xtrabackup-*/

  cmake \
      -DBUILD_CONFIG=xtrabackup_release \
      -DCMAKE_INSTALL_PREFIX=${PREFIX} \
      -DWITH_MAN_PAGES=OFF \
      -DWITH_BOOST=${PREFIX}
  make -j4
  make install
)
